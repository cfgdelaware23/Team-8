"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _metadataParser = _interopRequireDefault(require("../metadata-parser"));
var _token = require("./token");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function readTableName(parser, options, metadata, callback) {
  if (metadata.type.hasTableName) {
    if (options.tdsVersion >= '7_2') {
      parser.readUInt8(numberOfTableNameParts => {
        const tableName = [];
        let i = 0;
        function next(done) {
          if (numberOfTableNameParts === i) {
            return done();
          }
          parser.readUsVarChar(part => {
            tableName.push(part);
            i++;
            next(done);
          });
        }
        next(() => {
          callback(tableName);
        });
      });
    } else {
      parser.readUsVarChar(callback);
    }
  } else {
    callback(undefined);
  }
}
function readColumnName(parser, options, index, metadata, callback) {
  parser.readBVarChar(colName => {
    if (options.columnNameReplacer) {
      callback(options.columnNameReplacer(colName, index, metadata));
    } else if (options.camelCaseColumns) {
      callback(colName.replace(/^[A-Z]/, function (s) {
        return s.toLowerCase();
      }));
    } else {
      callback(colName);
    }
  });
}
function readColumn(parser, options, index, callback) {
  (0, _metadataParser.default)(parser, options, metadata => {
    readTableName(parser, options, metadata, tableName => {
      readColumnName(parser, options, index, metadata, colName => {
        callback({
          userType: metadata.userType,
          flags: metadata.flags,
          type: metadata.type,
          collation: metadata.collation,
          precision: metadata.precision,
          scale: metadata.scale,
          udtInfo: metadata.udtInfo,
          dataLength: metadata.dataLength,
          schema: metadata.schema,
          colName: colName,
          tableName: tableName
        });
      });
    });
  });
}
async function colMetadataParser(parser) {
  while (parser.buffer.length - parser.position < 2) {
    await parser.streamBuffer.waitForChunk();
  }
  const columnCount = parser.buffer.readUInt16LE(parser.position);
  parser.position += 2;
  const columns = [];
  for (let i = 0; i < columnCount; i++) {
    let column;
    readColumn(parser, parser.options, i, c => {
      column = c;
    });
    while (parser.suspended) {
      await parser.streamBuffer.waitForChunk();
      parser.suspended = false;
      const next = parser.next;
      next();
    }
    columns.push(column);
  }
  return new _token.ColMetadataToken(columns);
}
var _default = colMetadataParser;
exports.default = _default;
module.exports = colMetadataParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbWV0YWRhdGFQYXJzZXIiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl90b2tlbiIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwicmVhZFRhYmxlTmFtZSIsInBhcnNlciIsIm9wdGlvbnMiLCJtZXRhZGF0YSIsImNhbGxiYWNrIiwidHlwZSIsImhhc1RhYmxlTmFtZSIsInRkc1ZlcnNpb24iLCJyZWFkVUludDgiLCJudW1iZXJPZlRhYmxlTmFtZVBhcnRzIiwidGFibGVOYW1lIiwiaSIsIm5leHQiLCJkb25lIiwicmVhZFVzVmFyQ2hhciIsInBhcnQiLCJwdXNoIiwidW5kZWZpbmVkIiwicmVhZENvbHVtbk5hbWUiLCJpbmRleCIsInJlYWRCVmFyQ2hhciIsImNvbE5hbWUiLCJjb2x1bW5OYW1lUmVwbGFjZXIiLCJjYW1lbENhc2VDb2x1bW5zIiwicmVwbGFjZSIsInMiLCJ0b0xvd2VyQ2FzZSIsInJlYWRDb2x1bW4iLCJtZXRhZGF0YVBhcnNlIiwidXNlclR5cGUiLCJmbGFncyIsImNvbGxhdGlvbiIsInByZWNpc2lvbiIsInNjYWxlIiwidWR0SW5mbyIsImRhdGFMZW5ndGgiLCJzY2hlbWEiLCJjb2xNZXRhZGF0YVBhcnNlciIsImJ1ZmZlciIsImxlbmd0aCIsInBvc2l0aW9uIiwic3RyZWFtQnVmZmVyIiwid2FpdEZvckNodW5rIiwiY29sdW1uQ291bnQiLCJyZWFkVUludDE2TEUiLCJjb2x1bW5zIiwiY29sdW1uIiwiYyIsInN1c3BlbmRlZCIsIkNvbE1ldGFkYXRhVG9rZW4iLCJfZGVmYXVsdCIsImV4cG9ydHMiLCJtb2R1bGUiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvdG9rZW4vY29sbWV0YWRhdGEtdG9rZW4tcGFyc2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBtZXRhZGF0YVBhcnNlLCB7IHR5cGUgTWV0YWRhdGEgfSBmcm9tICcuLi9tZXRhZGF0YS1wYXJzZXInO1xuXG5pbXBvcnQgUGFyc2VyLCB7IHR5cGUgUGFyc2VyT3B0aW9ucyB9IGZyb20gJy4vc3RyZWFtLXBhcnNlcic7XG5pbXBvcnQgeyBDb2xNZXRhZGF0YVRva2VuIH0gZnJvbSAnLi90b2tlbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29sdW1uTWV0YWRhdGEgZXh0ZW5kcyBNZXRhZGF0YSB7XG4gIC8qKlxuICAgKiBUaGUgY29sdW1uJ3MgbmFtZeOAglxuICAgKi9cbiAgY29sTmFtZTogc3RyaW5nO1xuXG4gIHRhYmxlTmFtZT86IHN0cmluZyB8IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiByZWFkVGFibGVOYW1lKHBhcnNlcjogUGFyc2VyLCBvcHRpb25zOiBQYXJzZXJPcHRpb25zLCBtZXRhZGF0YTogTWV0YWRhdGEsIGNhbGxiYWNrOiAodGFibGVOYW1lPzogc3RyaW5nIHwgc3RyaW5nW10pID0+IHZvaWQpIHtcbiAgaWYgKG1ldGFkYXRhLnR5cGUuaGFzVGFibGVOYW1lKSB7XG4gICAgaWYgKG9wdGlvbnMudGRzVmVyc2lvbiA+PSAnN18yJykge1xuICAgICAgcGFyc2VyLnJlYWRVSW50OCgobnVtYmVyT2ZUYWJsZU5hbWVQYXJ0cykgPT4ge1xuICAgICAgICBjb25zdCB0YWJsZU5hbWU6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICBmdW5jdGlvbiBuZXh0KGRvbmU6ICgpID0+IHZvaWQpIHtcbiAgICAgICAgICBpZiAobnVtYmVyT2ZUYWJsZU5hbWVQYXJ0cyA9PT0gaSkge1xuICAgICAgICAgICAgcmV0dXJuIGRvbmUoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBwYXJzZXIucmVhZFVzVmFyQ2hhcigocGFydCkgPT4ge1xuICAgICAgICAgICAgdGFibGVOYW1lLnB1c2gocGFydCk7XG5cbiAgICAgICAgICAgIGkrKztcblxuICAgICAgICAgICAgbmV4dChkb25lKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5leHQoKCkgPT4ge1xuICAgICAgICAgIGNhbGxiYWNrKHRhYmxlTmFtZSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcnNlci5yZWFkVXNWYXJDaGFyKGNhbGxiYWNrKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY2FsbGJhY2sodW5kZWZpbmVkKTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZWFkQ29sdW1uTmFtZShwYXJzZXI6IFBhcnNlciwgb3B0aW9uczogUGFyc2VyT3B0aW9ucywgaW5kZXg6IG51bWJlciwgbWV0YWRhdGE6IE1ldGFkYXRhLCBjYWxsYmFjazogKGNvbE5hbWU6IHN0cmluZykgPT4gdm9pZCkge1xuICBwYXJzZXIucmVhZEJWYXJDaGFyKChjb2xOYW1lKSA9PiB7XG4gICAgaWYgKG9wdGlvbnMuY29sdW1uTmFtZVJlcGxhY2VyKSB7XG4gICAgICBjYWxsYmFjayhvcHRpb25zLmNvbHVtbk5hbWVSZXBsYWNlcihjb2xOYW1lLCBpbmRleCwgbWV0YWRhdGEpKTtcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMuY2FtZWxDYXNlQ29sdW1ucykge1xuICAgICAgY2FsbGJhY2soY29sTmFtZS5yZXBsYWNlKC9eW0EtWl0vLCBmdW5jdGlvbihzKSB7XG4gICAgICAgIHJldHVybiBzLnRvTG93ZXJDYXNlKCk7XG4gICAgICB9KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbGxiYWNrKGNvbE5hbWUpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlYWRDb2x1bW4ocGFyc2VyOiBQYXJzZXIsIG9wdGlvbnM6IFBhcnNlck9wdGlvbnMsIGluZGV4OiBudW1iZXIsIGNhbGxiYWNrOiAoY29sdW1uOiBDb2x1bW5NZXRhZGF0YSkgPT4gdm9pZCkge1xuICBtZXRhZGF0YVBhcnNlKHBhcnNlciwgb3B0aW9ucywgKG1ldGFkYXRhKSA9PiB7XG4gICAgcmVhZFRhYmxlTmFtZShwYXJzZXIsIG9wdGlvbnMsIG1ldGFkYXRhLCAodGFibGVOYW1lKSA9PiB7XG4gICAgICByZWFkQ29sdW1uTmFtZShwYXJzZXIsIG9wdGlvbnMsIGluZGV4LCBtZXRhZGF0YSwgKGNvbE5hbWUpID0+IHtcbiAgICAgICAgY2FsbGJhY2soe1xuICAgICAgICAgIHVzZXJUeXBlOiBtZXRhZGF0YS51c2VyVHlwZSxcbiAgICAgICAgICBmbGFnczogbWV0YWRhdGEuZmxhZ3MsXG4gICAgICAgICAgdHlwZTogbWV0YWRhdGEudHlwZSxcbiAgICAgICAgICBjb2xsYXRpb246IG1ldGFkYXRhLmNvbGxhdGlvbixcbiAgICAgICAgICBwcmVjaXNpb246IG1ldGFkYXRhLnByZWNpc2lvbixcbiAgICAgICAgICBzY2FsZTogbWV0YWRhdGEuc2NhbGUsXG4gICAgICAgICAgdWR0SW5mbzogbWV0YWRhdGEudWR0SW5mbyxcbiAgICAgICAgICBkYXRhTGVuZ3RoOiBtZXRhZGF0YS5kYXRhTGVuZ3RoLFxuICAgICAgICAgIHNjaGVtYTogbWV0YWRhdGEuc2NoZW1hLFxuICAgICAgICAgIGNvbE5hbWU6IGNvbE5hbWUsXG4gICAgICAgICAgdGFibGVOYW1lOiB0YWJsZU5hbWVcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbE1ldGFkYXRhUGFyc2VyKHBhcnNlcjogUGFyc2VyKTogUHJvbWlzZTxDb2xNZXRhZGF0YVRva2VuPiB7XG4gIHdoaWxlIChwYXJzZXIuYnVmZmVyLmxlbmd0aCAtIHBhcnNlci5wb3NpdGlvbiA8IDIpIHtcbiAgICBhd2FpdCBwYXJzZXIuc3RyZWFtQnVmZmVyLndhaXRGb3JDaHVuaygpO1xuICB9XG5cbiAgY29uc3QgY29sdW1uQ291bnQgPSBwYXJzZXIuYnVmZmVyLnJlYWRVSW50MTZMRShwYXJzZXIucG9zaXRpb24pO1xuICBwYXJzZXIucG9zaXRpb24gKz0gMjtcblxuICBjb25zdCBjb2x1bW5zOiBDb2x1bW5NZXRhZGF0YVtdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY29sdW1uQ291bnQ7IGkrKykge1xuICAgIGxldCBjb2x1bW46IENvbHVtbk1ldGFkYXRhO1xuXG4gICAgcmVhZENvbHVtbihwYXJzZXIsIHBhcnNlci5vcHRpb25zLCBpLCAoYykgPT4ge1xuICAgICAgY29sdW1uID0gYztcbiAgICB9KTtcblxuICAgIHdoaWxlIChwYXJzZXIuc3VzcGVuZGVkKSB7XG4gICAgICBhd2FpdCBwYXJzZXIuc3RyZWFtQnVmZmVyLndhaXRGb3JDaHVuaygpO1xuXG4gICAgICBwYXJzZXIuc3VzcGVuZGVkID0gZmFsc2U7XG4gICAgICBjb25zdCBuZXh0ID0gcGFyc2VyLm5leHQhO1xuXG4gICAgICBuZXh0KCk7XG4gICAgfVxuXG4gICAgY29sdW1ucy5wdXNoKGNvbHVtbiEpO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBDb2xNZXRhZGF0YVRva2VuKGNvbHVtbnMpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjb2xNZXRhZGF0YVBhcnNlcjtcbm1vZHVsZS5leHBvcnRzID0gY29sTWV0YWRhdGFQYXJzZXI7XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUFBLGVBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUdBLElBQUFDLE1BQUEsR0FBQUQsT0FBQTtBQUEyQyxTQUFBRCx1QkFBQUcsR0FBQSxXQUFBQSxHQUFBLElBQUFBLEdBQUEsQ0FBQUMsVUFBQSxHQUFBRCxHQUFBLEtBQUFFLE9BQUEsRUFBQUYsR0FBQTtBQVczQyxTQUFTRyxhQUFhQSxDQUFDQyxNQUFjLEVBQUVDLE9BQXNCLEVBQUVDLFFBQWtCLEVBQUVDLFFBQWlELEVBQUU7RUFDcEksSUFBSUQsUUFBUSxDQUFDRSxJQUFJLENBQUNDLFlBQVksRUFBRTtJQUM5QixJQUFJSixPQUFPLENBQUNLLFVBQVUsSUFBSSxLQUFLLEVBQUU7TUFDL0JOLE1BQU0sQ0FBQ08sU0FBUyxDQUFFQyxzQkFBc0IsSUFBSztRQUMzQyxNQUFNQyxTQUFtQixHQUFHLEVBQUU7UUFFOUIsSUFBSUMsQ0FBQyxHQUFHLENBQUM7UUFDVCxTQUFTQyxJQUFJQSxDQUFDQyxJQUFn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