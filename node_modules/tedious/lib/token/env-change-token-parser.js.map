{"version":3,"file":"env-change-token-parser.js","names":["_collation","require","_token","types","name","event","readNewAndOldValue","parser","length","type","callback","readBVarChar","newValue","oldValue","PacketSizeEnvChangeToken","parseInt","DatabaseEnvChangeToken","LanguageEnvChangeToken","CharsetEnvChangeToken","DatabaseMirroringPartnerEnvChangeToken","readBVarByte","newCollation","Collation","fromBuffer","undefined","oldCollation","CollationChangeToken","BeginTransactionEnvChangeToken","CommitTransactionEnvChangeToken","RollbackTransactionEnvChangeToken","ResetConnectionEnvChangeToken","readUInt16LE","valueLength","readBuffer","routePacket","protocol","readUInt8","Error","port","serverLen","server","toString","oldValueLength","RoutingEnvChangeToken","console","error","envChangeParser","_options","typeNumber","token","_default","exports","default","module"],"sources":["../../src/token/env-change-token-parser.ts"],"sourcesContent":["import Parser, { type ParserOptions } from './stream-parser';\nimport { Collation } from '../collation';\n\nimport {\n  DatabaseEnvChangeToken,\n  LanguageEnvChangeToken,\n  CharsetEnvChangeToken,\n  PacketSizeEnvChangeToken,\n  BeginTransactionEnvChangeToken,\n  CommitTransactionEnvChangeToken,\n  RollbackTransactionEnvChangeToken,\n  DatabaseMirroringPartnerEnvChangeToken,\n  ResetConnectionEnvChangeToken,\n  RoutingEnvChangeToken,\n  CollationChangeToken\n} from './token';\n\ntype EnvChangeToken =\n  DatabaseEnvChangeToken |\n  LanguageEnvChangeToken |\n  CharsetEnvChangeToken |\n  PacketSizeEnvChangeToken |\n  BeginTransactionEnvChangeToken |\n  CommitTransactionEnvChangeToken |\n  RollbackTransactionEnvChangeToken |\n  DatabaseMirroringPartnerEnvChangeToken |\n  ResetConnectionEnvChangeToken |\n  RoutingEnvChangeToken |\n  CollationChangeToken;\n\nconst types: { [key: number]: { name: string, event?: string }} = {\n  1: {\n    name: 'DATABASE',\n    event: 'databaseChange'\n  },\n  2: {\n    name: 'LANGUAGE',\n    event: 'languageChange'\n  },\n  3: {\n    name: 'CHARSET',\n    event: 'charsetChange'\n  },\n  4: {\n    name: 'PACKET_SIZE',\n    event: 'packetSizeChange'\n  },\n  7: {\n    name: 'SQL_COLLATION',\n    event: 'sqlCollationChange'\n  },\n  8: {\n    name: 'BEGIN_TXN',\n    event: 'beginTransaction'\n  },\n  9: {\n    name: 'COMMIT_TXN',\n    event: 'commitTransaction'\n  },\n  10: {\n    name: 'ROLLBACK_TXN',\n    event: 'rollbackTransaction'\n  },\n  13: {\n    name: 'DATABASE_MIRRORING_PARTNER',\n    event: 'partnerNode'\n  },\n  17: {\n    name: 'TXN_ENDED'\n  },\n  18: {\n    name: 'RESET_CONNECTION',\n    event: 'resetConnection'\n  },\n  20: {\n    name: 'ROUTING_CHANGE',\n    event: 'routingChange'\n  }\n};\n\nfunction readNewAndOldValue(parser: Parser, length: number, type: { name: string, event?: string }, callback: (token: EnvChangeToken | undefined) => void) {\n  switch (type.name) {\n    case 'DATABASE':\n    case 'LANGUAGE':\n    case 'CHARSET':\n    case 'PACKET_SIZE':\n    case 'DATABASE_MIRRORING_PARTNER':\n      return parser.readBVarChar((newValue) => {\n        parser.readBVarChar((oldValue) => {\n          switch (type.name) {\n            case 'PACKET_SIZE':\n              return callback(new PacketSizeEnvChangeToken(parseInt(newValue), parseInt(oldValue)));\n\n            case 'DATABASE':\n              return callback(new DatabaseEnvChangeToken(newValue, oldValue));\n\n            case 'LANGUAGE':\n              return callback(new LanguageEnvChangeToken(newValue, oldValue));\n\n            case 'CHARSET':\n              return callback(new CharsetEnvChangeToken(newValue, oldValue));\n\n            case 'DATABASE_MIRRORING_PARTNER':\n              return callback(new DatabaseMirroringPartnerEnvChangeToken(newValue, oldValue));\n          }\n        });\n      });\n\n    case 'SQL_COLLATION':\n    case 'BEGIN_TXN':\n    case 'COMMIT_TXN':\n    case 'ROLLBACK_TXN':\n    case 'RESET_CONNECTION':\n      return parser.readBVarByte((newValue) => {\n        parser.readBVarByte((oldValue) => {\n          switch (type.name) {\n            case 'SQL_COLLATION': {\n              const newCollation = newValue.length ? Collation.fromBuffer(newValue) : undefined;\n              const oldCollation = oldValue.length ? Collation.fromBuffer(oldValue) : undefined;\n\n              return callback(new CollationChangeToken(newCollation, oldCollation));\n            }\n\n            case 'BEGIN_TXN':\n              return callback(new BeginTransactionEnvChangeToken(newValue, oldValue));\n\n            case 'COMMIT_TXN':\n              return callback(new CommitTransactionEnvChangeToken(newValue, oldValue));\n\n            case 'ROLLBACK_TXN':\n              return callback(new RollbackTransactionEnvChangeToken(newValue, oldValue));\n\n            case 'RESET_CONNECTION':\n              return callback(new ResetConnectionEnvChangeToken(newValue, oldValue));\n          }\n        });\n      });\n\n    case 'ROUTING_CHANGE':\n      return parser.readUInt16LE((valueLength) => {\n        // Routing Change:\n        // Byte 1: Protocol (must be 0)\n        // Bytes 2-3 (USHORT): Port number\n        // Bytes 4-5 (USHORT): Length of server data in unicode (2byte chars)\n        // Bytes 6-*: Server name in unicode characters\n        parser.readBuffer(valueLength, (routePacket) => {\n          const protocol = routePacket.readUInt8(0);\n\n          if (protocol !== 0) {\n            throw new Error('Unknown protocol byte in routing change event');\n          }\n\n          const port = routePacket.readUInt16LE(1);\n          const serverLen = routePacket.readUInt16LE(3);\n          // 2 bytes per char, starting at offset 5\n          const server = routePacket.toString('ucs2', 5, 5 + (serverLen * 2));\n\n          const newValue = {\n            protocol: protocol,\n            port: port,\n            server: server\n          };\n\n          parser.readUInt16LE((oldValueLength) => {\n            parser.readBuffer(oldValueLength, (oldValue) => {\n              callback(new RoutingEnvChangeToken(newValue, oldValue));\n            });\n          });\n        });\n      });\n\n    default:\n      console.error('Tedious > Unsupported ENVCHANGE type ' + type.name);\n      // skip unknown bytes\n      parser.readBuffer(length - 1, () => {\n        callback(undefined);\n      });\n  }\n}\n\nfunction envChangeParser(parser: Parser, _options: ParserOptions, callback: (token: EnvChangeToken | undefined) => void) {\n  parser.readUInt16LE((length) => {\n    parser.readUInt8((typeNumber) => {\n      const type = types[typeNumber];\n\n      if (!type) {\n        console.error('Tedious > Unsupported ENVCHANGE type ' + typeNumber);\n        // skip unknown bytes\n        return parser.readBuffer(length - 1, () => {\n          callback(undefined);\n        });\n      }\n\n      readNewAndOldValue(parser, length, type, (token) => {\n        callback(token);\n      });\n    });\n  });\n}\n\nexport default envChangeParser;\nmodule.exports = envChangeParser;\n"],"mappings":"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"}