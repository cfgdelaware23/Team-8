"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _collation = require("../collation");
var _token = require("./token");
const types = {
  1: {
    name: 'DATABASE',
    event: 'databaseChange'
  },
  2: {
    name: 'LANGUAGE',
    event: 'languageChange'
  },
  3: {
    name: 'CHARSET',
    event: 'charsetChange'
  },
  4: {
    name: 'PACKET_SIZE',
    event: 'packetSizeChange'
  },
  7: {
    name: 'SQL_COLLATION',
    event: 'sqlCollationChange'
  },
  8: {
    name: 'BEGIN_TXN',
    event: 'beginTransaction'
  },
  9: {
    name: 'COMMIT_TXN',
    event: 'commitTransaction'
  },
  10: {
    name: 'ROLLBACK_TXN',
    event: 'rollbackTransaction'
  },
  13: {
    name: 'DATABASE_MIRRORING_PARTNER',
    event: 'partnerNode'
  },
  17: {
    name: 'TXN_ENDED'
  },
  18: {
    name: 'RESET_CONNECTION',
    event: 'resetConnection'
  },
  20: {
    name: 'ROUTING_CHANGE',
    event: 'routingChange'
  }
};
function readNewAndOldValue(parser, length, type, callback) {
  switch (type.name) {
    case 'DATABASE':
    case 'LANGUAGE':
    case 'CHARSET':
    case 'PACKET_SIZE':
    case 'DATABASE_MIRRORING_PARTNER':
      return parser.readBVarChar(newValue => {
        parser.readBVarChar(oldValue => {
          switch (type.name) {
            case 'PACKET_SIZE':
              return callback(new _token.PacketSizeEnvChangeToken(parseInt(newValue), parseInt(oldValue)));
            case 'DATABASE':
              return callback(new _token.DatabaseEnvChangeToken(newValue, oldValue));
            case 'LANGUAGE':
              return callback(new _token.LanguageEnvChangeToken(newValue, oldValue));
            case 'CHARSET':
              return callback(new _token.CharsetEnvChangeToken(newValue, oldValue));
            case 'DATABASE_MIRRORING_PARTNER':
              return callback(new _token.DatabaseMirroringPartnerEnvChangeToken(newValue, oldValue));
          }
        });
      });
    case 'SQL_COLLATION':
    case 'BEGIN_TXN':
    case 'COMMIT_TXN':
    case 'ROLLBACK_TXN':
    case 'RESET_CONNECTION':
      return parser.readBVarByte(newValue => {
        parser.readBVarByte(oldValue => {
          switch (type.name) {
            case 'SQL_COLLATION':
              {
                const newCollation = newValue.length ? _collation.Collation.fromBuffer(newValue) : undefined;
                const oldCollation = oldValue.length ? _collation.Collation.fromBuffer(oldValue) : undefined;
                return callback(new _token.CollationChangeToken(newCollation, oldCollation));
              }
            case 'BEGIN_TXN':
              return callback(new _token.BeginTransactionEnvChangeToken(newValue, oldValue));
            case 'COMMIT_TXN':
              return callback(new _token.CommitTransactionEnvChangeToken(newValue, oldValue));
            case 'ROLLBACK_TXN':
              return callback(new _token.RollbackTransactionEnvChangeToken(newValue, oldValue));
            case 'RESET_CONNECTION':
              return callback(new _token.ResetConnectionEnvChangeToken(newValue, oldValue));
          }
        });
      });
    case 'ROUTING_CHANGE':
      return parser.readUInt16LE(valueLength => {
        // Routing Change:
        // Byte 1: Protocol (must be 0)
        // Bytes 2-3 (USHORT): Port number
        // Bytes 4-5 (USHORT): Length of server data in unicode (2byte chars)
        // Bytes 6-*: Server name in unicode characters
        parser.readBuffer(valueLength, routePacket => {
          const protocol = routePacket.readUInt8(0);
          if (protocol !== 0) {
            throw new Error('Unknown protocol byte in routing change event');
          }
          const port = routePacket.readUInt16LE(1);
          const serverLen = routePacket.readUInt16LE(3);
          // 2 bytes per char, starting at offset 5
          const server = routePacket.toString('ucs2', 5, 5 + serverLen * 2);
          const newValue = {
            protocol: protocol,
            port: port,
            server: server
          };
          parser.readUInt16LE(oldValueLength => {
            parser.readBuffer(oldValueLength, oldValue => {
              callback(new _token.RoutingEnvChangeToken(newValue, oldValue));
            });
          });
        });
      });
    default:
      console.error('Tedious > Unsupported ENVCHANGE type ' + type.name);
      // skip unknown bytes
      parser.readBuffer(length - 1, () => {
        callback(undefined);
      });
  }
}
function envChangeParser(parser, _options, callback) {
  parser.readUInt16LE(length => {
    parser.readUInt8(typeNumber => {
      const type = types[typeNumber];
      if (!type) {
        console.error('Tedious > Unsupported ENVCHANGE type ' + typeNumber);
        // skip unknown bytes
        return parser.readBuffer(length - 1, () => {
          callback(undefined);
        });
      }
      readNewAndOldValue(parser, length, type, token => {
        callback(token);
      });
    });
  });
}
var _default = envChangeParser;
exports.default = _default;
module.exports = envChangeParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY29sbGF0aW9uIiwicmVxdWlyZSIsIl90b2tlbiIsInR5cGVzIiwibmFtZSIsImV2ZW50IiwicmVhZE5ld0FuZE9sZFZhbHVlIiwicGFyc2VyIiwibGVuZ3RoIiwidHlwZSIsImNhbGxiYWNrIiwicmVhZEJWYXJDaGFyIiwibmV3VmFsdWUiLCJvbGRWYWx1ZSIsIlBhY2tldFNpemVFbnZDaGFuZ2VUb2tlbiIsInBhcnNlSW50IiwiRGF0YWJhc2VFbnZDaGFuZ2VUb2tlbiIsIkxhbmd1YWdlRW52Q2hhbmdlVG9rZW4iLCJDaGFyc2V0RW52Q2hhbmdlVG9rZW4iLCJEYXRhYmFzZU1pcnJvcmluZ1BhcnRuZXJFbnZDaGFuZ2VUb2tlbiIsInJlYWRCVmFyQnl0ZSIsIm5ld0NvbGxhdGlvbiIsIkNvbGxhdGlvbiIsImZyb21CdWZmZXIiLCJ1bmRlZmluZWQiLCJvbGRDb2xsYXRpb24iLCJDb2xsYXRpb25DaGFuZ2VUb2tlbiIsIkJlZ2luVHJhbnNhY3Rpb25FbnZDaGFuZ2VUb2tlbiIsIkNvbW1pdFRyYW5zYWN0aW9uRW52Q2hhbmdlVG9rZW4iLCJSb2xsYmFja1RyYW5zYWN0aW9uRW52Q2hhbmdlVG9rZW4iLCJSZXNldENvbm5lY3Rpb25FbnZDaGFuZ2VUb2tlbiIsInJlYWRVSW50MTZMRSIsInZhbHVlTGVuZ3RoIiwicmVhZEJ1ZmZlciIsInJvdXRlUGFja2V0IiwicHJvdG9jb2wiLCJyZWFkVUludDgiLCJFcnJvciIsInBvcnQiLCJzZXJ2ZXJMZW4iLCJzZXJ2ZXIiLCJ0b1N0cmluZyIsIm9sZFZhbHVlTGVuZ3RoIiwiUm91dGluZ0VudkNoYW5nZVRva2VuIiwiY29uc29sZSIsImVycm9yIiwiZW52Q2hhbmdlUGFyc2VyIiwiX29wdGlvbnMiLCJ0eXBlTnVtYmVyIiwidG9rZW4iLCJfZGVmYXVsdCIsImV4cG9ydHMiLCJkZWZhdWx0IiwibW9kdWxlIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL3Rva2VuL2Vudi1jaGFuZ2UtdG9rZW4tcGFyc2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQYXJzZXIsIHsgdHlwZSBQYXJzZXJPcHRpb25zIH0gZnJvbSAnLi9zdHJlYW0tcGFyc2VyJztcbmltcG9ydCB7IENvbGxhdGlvbiB9IGZyb20gJy4uL2NvbGxhdGlvbic7XG5cbmltcG9ydCB7XG4gIERhdGFiYXNlRW52Q2hhbmdlVG9rZW4sXG4gIExhbmd1YWdlRW52Q2hhbmdlVG9rZW4sXG4gIENoYXJzZXRFbnZDaGFuZ2VUb2tlbixcbiAgUGFja2V0U2l6ZUVudkNoYW5nZVRva2VuLFxuICBCZWdpblRyYW5zYWN0aW9uRW52Q2hhbmdlVG9rZW4sXG4gIENvbW1pdFRyYW5zYWN0aW9uRW52Q2hhbmdlVG9rZW4sXG4gIFJvbGxiYWNrVHJhbnNhY3Rpb25FbnZDaGFuZ2VUb2tlbixcbiAgRGF0YWJhc2VNaXJyb3JpbmdQYXJ0bmVyRW52Q2hhbmdlVG9rZW4sXG4gIFJlc2V0Q29ubmVjdGlvbkVudkNoYW5nZVRva2VuLFxuICBSb3V0aW5nRW52Q2hhbmdlVG9rZW4sXG4gIENvbGxhdGlvbkNoYW5nZVRva2VuXG59IGZyb20gJy4vdG9rZW4nO1xuXG50eXBlIEVudkNoYW5nZVRva2VuID1cbiAgRGF0YWJhc2VFbnZDaGFuZ2VUb2tlbiB8XG4gIExhbmd1YWdlRW52Q2hhbmdlVG9rZW4gfFxuICBDaGFyc2V0RW52Q2hhbmdlVG9rZW4gfFxuICBQYWNrZXRTaXplRW52Q2hhbmdlVG9rZW4gfFxuICBCZWdpblRyYW5zYWN0aW9uRW52Q2hhbmdlVG9rZW4gfFxuICBDb21taXRUcmFuc2FjdGlvbkVudkNoYW5nZVRva2VuIHxcbiAgUm9sbGJhY2tUcmFuc2FjdGlvbkVudkNoYW5nZVRva2VuIHxcbiAgRGF0YWJhc2VNaXJyb3JpbmdQYXJ0bmVyRW52Q2hhbmdlVG9rZW4gfFxuICBSZXNldENvbm5lY3Rpb25FbnZDaGFuZ2VUb2tlbiB8XG4gIFJvdXRpbmdFbnZDaGFuZ2VUb2tlbiB8XG4gIENvbGxhdGlvbkNoYW5nZVRva2VuO1xuXG5jb25zdCB0eXBlczogeyBba2V5OiBudW1iZXJdOiB7IG5hbWU6IHN0cmluZywgZXZlbnQ/OiBzdHJpbmcgfX0gPSB7XG4gIDE6IHtcbiAgICBuYW1lOiAnREFUQUJBU0UnLFxuICAgIGV2ZW50OiAnZGF0YWJhc2VDaGFuZ2UnXG4gIH0sXG4gIDI6IHtcbiAgICBuYW1lOiAnTEFOR1VBR0UnLFxuICAgIGV2ZW50OiAnbGFuZ3VhZ2VDaGFuZ2UnXG4gIH0sXG4gIDM6IHtcbiAgICBuYW1lOiAnQ0hBUlNFVCcsXG4gICAgZXZlbnQ6ICdjaGFyc2V0Q2hhbmdlJ1xuICB9LFxuICA0OiB7XG4gICAgbmFtZTogJ1BBQ0tFVF9TSVpFJyxcbiAgICBldmVudDogJ3BhY2tldFNpemVDaGFuZ2UnXG4gIH0sXG4gIDc6IHtcbiAgICBuYW1lOiAnU1FMX0NPTExBVElPTicsXG4gICAgZXZlbnQ6ICdzcWxDb2xsYXRpb25DaGFuZ2UnXG4gIH0sXG4gIDg6IHtcbiAgICBuYW1lOiAnQkVHSU5fVFhOJyxcbiAgICBldmVudDogJ2JlZ2luVHJhbnNhY3Rpb24nXG4gIH0sXG4gIDk6IHtcbiAgICBuYW1lOiAnQ09NTUlUX1RYTicsXG4gICAgZXZlbnQ6ICdjb21taXRUcmFuc2FjdGlvbidcbiAgfSxcbiAgMTA6IHtcbiAgICBuYW1lOiAnUk9MTEJBQ0tfVFhOJyxcbiAgICBldmVudDogJ3JvbGxiYWNrVHJhbnNhY3Rpb24nXG4gIH0sXG4gIDEzOiB7XG4gICAgbmFtZTogJ0RBVEFCQVNFX01JUlJPUklOR19QQVJUTkVSJyxcbiAgICBldmVudDogJ3BhcnRuZXJOb2RlJ1xuICB9LFxuICAxNzoge1xuICAgIG5hbWU6ICdUWE5fRU5ERUQnXG4gIH0sXG4gIDE4OiB7XG4gICAgbmFtZTogJ1JFU0VUX0NPTk5FQ1RJT04nLFxuICAgIGV2ZW50OiAncmVzZXRDb25uZWN0aW9uJ1xuICB9LFxuICAyMDoge1xuICAgIG5hbWU6ICdST1VUSU5HX0NIQU5HRScsXG4gICAgZXZlbnQ6ICdyb3V0aW5nQ2hhbmdlJ1xuICB9XG59O1xuXG5mdW5jdGlvbiByZWFkTmV3QW5kT2xkVmFsdWUocGFyc2VyOiBQYXJzZXIsIGxlbmd0aDogbnVtYmVyLCB0eXBlOiB7IG5hbWU6IHN0cmluZywgZXZlbnQ/OiBzdHJpbmcgfSwgY2FsbGJhY2s6ICh0b2tlbjogRW52Q2hhbmdlVG9rZW4gfCB1bmRlZmluZWQpID0+IHZvaWQpIHtcbiAgc3dpdGNoICh0eXBlLm5hbWUpIHtcbiAgICBjYXNlICdEQVRBQkFTRSc6XG4gICAgY2FzZSAnTEFOR1VBR0UnOlxuICAgIGNhc2UgJ0NIQVJTRVQnOlxuICAgIGNhc2UgJ1BBQ0tFVF9TSVpFJzpcbiAgICBjYXNlICdEQVRBQkFTRV9NSVJST1JJTkdfUEFSVE5FUic6XG4gICAgICByZXR1cm4gcGFyc2VyLnJlYWRCVmFyQ2hhcigobmV3VmFsdWUpID0+IHtcbiAgICAgICAgcGFyc2VyLnJlYWRCVmFyQ2hhcigob2xkVmFsdWUpID0+IHtcbiAgICAgICAgICBzd2l0Y2ggKHR5cGUubmFtZSkge1xuICAgICAgICAgICAgY2FzZSAnUEFDS0VUX1NJWkUnOlxuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IFBhY2tldFNpemVFbnZDaGFuZ2VUb2tlbihwYXJzZUludChuZXdWYWx1ZSksIHBhcnNlSW50KG9sZFZhbHVlKSkpO1xuXG4gICAgICAgICAgICBjYXNlICdEQVRBQkFTRSc6XG4gICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRGF0YWJhc2VFbnZDaGFuZ2VUb2tlbihuZXdWYWx1ZSwgb2xkVmFsdWUpKTtcblxuICAgICAgICAgICAgY2FzZSAnTEFOR1VBR0UnOlxuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IExhbmd1YWdlRW52Q2hhbmdlVG9rZW4obmV3VmFsdWUsIG9sZFZhbHVlKSk7XG5cbiAgICAgICAgICAgIGNhc2UgJ0NIQVJTRVQnOlxuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IENoYXJzZXRFbnZDaGFuZ2VUb2tlbihuZXdWYWx1ZSwgb2xkVmFsdWUpKTtcblxuICAgICAgICAgICAgY2FzZSAnREFUQUJBU0VfTUlSUk9SSU5HX1BBUlRORVInOlxuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IERhdGFiYXNlTWlycm9yaW5nUGFydG5lckVudkNoYW5nZVRva2VuKG5ld1ZhbHVlLCBvbGRWYWx1ZSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgIGNhc2UgJ1NRTF9DT0xMQVRJT04nOlxuICAgIGNhc2UgJ0JFR0lOX1RYTic6XG4gICAgY2FzZSAnQ09NTUlUX1RYTic6XG4gICAgY2FzZSAnUk9MTEJBQ0tfVFhOJzpcbiAgICBjYXNlICdSRVNFVF9DT05ORUNUSU9OJzpcbiAgICAgIHJldHVybiBwYXJzZXIucmVhZEJWYXJCeXRlKChuZXdWYWx1ZSkgPT4ge1xuICAgICAgICBwYXJzZXIucmVhZEJWYXJCeXRlKChvbGRWYWx1ZSkgPT4ge1xuICAgICAgICAgIHN3aXRjaCAodHlwZS5uYW1lKSB7XG4gICAgICAgICAgICBjYXNlICdTUUxfQ09MTEFUSU9OJzoge1xuICAgICAgICAgICAgICBjb25zdCBuZXdDb2xsYXRpb24gPSBuZXdWYWx1ZS5sZW5ndGggPyBDb2xsYXRpb24uZnJvbUJ1ZmZlcihuZXdWYWx1ZSkgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgIGNvbnN0IG9sZENvbGxhdGlvbiA9IG9sZFZhbHVlLmxlbmd0aCA/IENvbGxhdGlvbi5mcm9tQnVmZmVyKG9sZFZhbHVlKSA6IHVuZGVmaW5lZDtcblxuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IENvbGxhdGlvbkNoYW5nZVRva2VuKG5ld0NvbGxhdGlvbiwgb2xkQ29sbGF0aW9uKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNhc2UgJ0JFR0lOX1RYTic6XG4gICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgQmVnaW5UcmFuc2FjdGlvbkVudkNoYW5nZVRva2VuKG5ld1ZhbHVlLCBvbGRWYWx1ZSkpO1xuXG4gICAgICAgICAgICBjYXNlICdDT01NSVRfVFhOJzpcbiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBDb21taXRUcmFuc2FjdGlvbkVudkNoYW5nZVRva2VuKG5ld1ZhbHVlLCBvbGRWYWx1ZSkpO1xuXG4gICAgICAgICAgICBjYXNlICdST0xMQkFDS19UWE4nOlxuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IFJvbGxiYWNrVHJhbnNhY3Rpb25FbnZDaGFuZ2VUb2tlbihuZXdWYWx1ZSwgb2xkVmFsdWUpKTtcblxuICAgICAgICAgICAgY2FzZSAnUkVTRVRfQ09OTkVDVElPTic6XG4gICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgUmVzZXRDb25uZWN0aW9uRW52Q2hhbmdlVG9rZW4obmV3VmFsdWUsIG9sZFZhbHVlKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgY2FzZSAnUk9VVElOR19DSEFOR0UnOlxuICAgICAgcmV0dXJuIHBhcnNlci5yZWFkVUludDE2TEUoKHZhbHVlTGVuZ3RoKSA9PiB7XG4gICAgICAgIC8vIFJvdXRpbmcgQ2hhbmdlOlxuICAgICAgICAvLyBCeXRlIDE6IFByb3RvY29sIChtdXN0IGJlIDApXG4gICAgICAgIC8vIEJ5dGVzIDItMyAoVVNIT1JUKTogUG9ydCBudW1iZXJcbiAgICAgICAgLy8gQnl0ZXMgNC01IChVU0hPUlQpOiBMZW5ndGggb2Ygc2VydmVyIGRhdGEgaW4gdW5pY29kZSAoMmJ5dGUgY2hhcnMpXG4gICAgICAgIC8vIEJ5dGVzIDYtKjogU2VydmVyIG5hbWUgaW4gdW5pY29kZSBjaGFyYWN0ZXJzXG4gICAgICAgIHBhcnNlci5yZWFkQnVmZmVyKHZhbHVlTGVuZ3RoLCAocm91dGVQYWNrZXQpID0+IHtcbiAgICAgICAgICBjb25zdCBwcm90b2NvbCA9IHJvdXRlUGFja2V0LnJlYWRVSW50OCgwKTtcblxuICAgICAgICAgIGlmIChwcm90b2NvbCAhPT0gMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHByb3RvY29sIGJ5dGUgaW4gcm91dGluZyBjaGFuZ2UgZXZlbnQnKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBwb3J0ID0gcm91dGVQYWNrZXQucmVhZFVJbnQxNkxFKDEpO1xuICAgICAgICAgIGNvbnN0IHNlcnZlckxlbiA9IHJvdXRlUGFja2V0LnJlYWRVSW50MTZMRSgzKTtcbiAgICAgICAgICAvLyAyIGJ5dGVzIHBlciBjaGFyLCBzdGFydGluZyBhdCBvZmZzZXQgNVxuICAgICAgICAgIGNvbnN0IHNlcnZlciA9IHJvdXRlUGFja2V0LnRvU3RyaW5nKCd1Y3MyJywgNSwgNSArIChzZXJ2ZXJMZW4gKiAyKSk7XG5cbiAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHtcbiAgICAgICAgICAgIHByb3RvY29sOiBwcm90b2NvbCxcbiAgICAgICAgICAgIHBvcnQ6IHBvcnQsXG4gICAgICAgICAgICBzZXJ2ZXI6IHNlcnZlclxuICAgICAgICAgIH07XG5cbiAgICAgICAgICBwYXJzZXIucmVhZFVJbnQxNkxFKChvbGRWYWx1ZUxlbmd0aCkgPT4ge1xuICAgICAgICAgICAgcGFyc2VyLnJlYWRCdWZmZXIob2xkVmFsdWVMZW5ndGgsIChvbGRWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgICBjYWxsYmFjayhuZXcgUm91dGluZ0VudkNoYW5nZVRva2VuKG5ld1ZhbHVlLCBvbGRWYWx1ZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICBkZWZhdWx0OlxuICAgICAgY29uc29sZS5lcnJvcignVGVkaW91cyA+IFVuc3VwcG9ydGVkIEVOVkNIQU5HRSB0eXBlICcgKyB0eXBlLm5hbWUpO1xuICAgICAgLy8gc2tpcCB1bmtub3duIGJ5dGVzXG4gICAgICBwYXJzZXIucmVhZEJ1ZmZlcihsZW5ndGggLSAxLCAoKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCk7XG4gICAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBlbnZDaGFuZ2VQYXJzZXIocGFyc2VyOiBQYXJzZXIsIF9vcHRpb25zOiBQYXJzZXJPcHRpb25zLCBjYWxsYmFjazogKHRva2VuOiBFbnZDaGFuZ2VUb2tlbiB8IHVuZGVmaW5lZCkgPT4gdm9pZCkge1xuICBwYXJzZXIucmVhZFVJbnQxNkxFKChsZW5ndGgpID0+IHtcbiAgICBwYXJzZXIucmVhZFVJbnQ4KCh0eXBlTnVtYmVyKSA9PiB7XG4gICAgICBjb25zdCB0eXBlID0gdHlwZXNbdHlwZU51bWJlcl07XG5cbiAgICAgIGlmICghdHlwZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdUZWRpb3VzID4gVW5zdXBwb3J0ZWQgRU5WQ0hBTkdFIHR5cGUgJyArIHR5cGVOdW1iZXIpO1xuICAgICAgICAvLyBza2lwIHVua25vd24gYnl0ZXNcbiAgICAgICAgcmV0dXJuIHBhcnNlci5yZWFkQnVmZmVyKGxlbmd0aCAtIDEsICgpID0+IHtcbiAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmVhZE5ld0FuZE9sZFZhbHVlKHBhcnNlciwgbGVuZ3RoLCB0eXBlLCAodG9rZW4pID0+IHtcbiAgICAgICAgY2FsbGJhY2sodG9rZW4pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBlbnZDaGFuZ2VQYXJzZXI7XG5tb2R1bGUuZXhwb3J0cyA9IGVudkNoYW5nZVBhcnNlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsSUFBQUEsVUFBQSxHQUFBQyxPQUFBO0FBRUEsSUFBQUMsTUFBQSxHQUFBRCxPQUFBO0FBMkJBLE1BQU1FLEtBQXlELEdBQUc7RUFDaEUsQ0FBQyxFQUFFO0lBQ0RDLElBQUksRUFBRSxVQUFVO0lBQ2hCQyxLQUFLLEVBQUU7RUFDVCxDQUFDO0VBQ0QsQ0FBQyxFQUFFO0lBQ0RELElBQUksRUFBRSxVQUFVO0lBQ2hCQyxLQUFLLEVBQUU7RUFD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